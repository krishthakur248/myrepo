<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Pulling - Find a Ride</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top-color: #3B82F6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .match-card {
            transition: all 0.3s ease;
        }
        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        #mapContainer {
            height: 400px;
            border-radius: 8px;
            z-index: 10;
        }
        .map-modal {
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-car text-blue-600 text-2xl"></i>
                <span class="font-bold text-xl">Car Pulling</span>
            </div>
            <div class="flex gap-4">
                <a href="Dashboard.html" class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded">Dashboard</a>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Logout</button>
            </div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto p-4 mt-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Find a Ride</h1>
            <p class="text-gray-600">Search for rides near you and save money</p>
        </div>

        <!-- Form Container -->
        <div class="bg-white rounded-lg shadow-lg p-8 space-y-6">

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg flex items-start gap-3">
                <i class="fas fa-exclamation-circle mt-0.5"></i>
                <span id="errorText"></span>
            </div>

            <!-- Search Form -->
            <form id="searchForm" onsubmit="handleSearch(event)" class="space-y-6">

                <!-- Pickup Location -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-map-pin text-green-600 mr-2"></i>Pickup Location
                    </label>
                    <input type="text" id="pickupLocationName" placeholder="Enter pickup location or click 'Get Current Location'"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                           required>
                    <input type="hidden" id="pickupLat">
                    <input type="hidden" id="pickupLng">
                    <div class="mt-2 flex gap-2">
                        <button type="button" onclick="getCurrentLocation('pickup')"
                                class="text-blue-600 hover:underline text-sm font-medium">
                            <i class="fas fa-location-arrow mr-1"></i>Use Current Location
                        </button>
                        <button type="button" onclick="openMapModal('pickup')"
                                class="text-blue-600 hover:underline text-sm font-medium">
                            <i class="fas fa-map mr-1"></i>Pick on Map
                        </button>
                    </div>
                </div>

                <!-- Dropoff Location -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-map-pin text-red-600 mr-2"></i>Dropoff Location
                    </label>
                    <input type="text" id="dropoffLocationName" placeholder="Enter destination"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                           required>
                    <input type="hidden" id="dropoffLat">
                    <input type="hidden" id="dropoffLng">
                    <small class="text-gray-500">Use address or coordinates (lat,lng)</small>
                    <div class="mt-2">
                        <button type="button" onclick="openMapModal('dropoff')"
                                class="text-blue-600 hover:underline text-sm font-medium">
                            <i class="fas fa-map mr-1"></i>Pick on Map
                        </button>
                    </div>
                </div>

                <!-- Search Button -->
                <button type="submit" id="searchBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2 shadow-md">
                    <i class="fas fa-search"></i>Search Rides
                </button>
            </form>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-12">
                <div class="inline-block">
                    <div class="w-12 h-12 loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">Searching for rides...</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden space-y-6">
                <!-- Results Header -->
                <div class="border-t pt-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">
                            Available Rides <span id="matchCount" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-lg ml-2">0</span>
                        </h2>
                        <button type="button" onclick="handleSearch()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                            <i class="fas fa-redo"></i>Refresh
                        </button>
                    </div>

                    <!-- Matches Grid -->
                    <div id="matchesGrid" class="space-y-4">
                        <!-- Matches will be inserted here -->
                    </div>

                    <!-- No Results -->
                    <div id="noResults" class="hidden text-center py-12 bg-blue-50 rounded-lg border-2 border-blue-200">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg font-bold">No matching rides found</p>
                        <p class="text-gray-500 text-sm mt-2">Try adjusting your search or checking later</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Join Trip Modal -->
        <div id="joinModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Confirm Trip Join</h3>

                <div id="modalContent" class="space-y-4 mb-6">
                    <!-- Trip details will be inserted here -->
                </div>

                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                        Cancel
                    </button>
                    <button id="confirmJoinBtn" onclick="confirmJoin()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        Join Ride
                    </button>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="mt-8 bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg">
            <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                <i class="fas fa-info-circle"></i>How it Works
            </h3>
            <ol class="text-blue-800 space-y-2 ml-6 list-decimal">
                <li>Enter your pickup and dropoff locations</li>
                <li>Click "Search Rides" to find available trips</li>
                <li>Browse matching trips with highest match scores</li>
                <li>Click "Join This Ride" to send a request to the driver</li>
                <li>Wait for driver confirmation to start your journey!</li>
            </ol>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center map-modal">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold"><i class="fas fa-map mr-2"></i>Select Location on Map</h2>
                <button type="button" onclick="closeMapModal()" class="text-gray-600 hover:text-gray-900 text-2xl">
                    &times;
                </button>
            </div>
            <div class="p-4">
                <div id="mapContainer"></div>
                <p class="text-sm text-gray-600 mt-3 text-center">Click on the map to select location</p>
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                    <p class="text-sm font-semibold">Selected: <span id="selectedCoords" class="text-blue-600">Click on map</span></p>
                </div>
            </div>
            <div class="flex gap-2 p-4 border-t">
                <button type="button" onclick="confirmMapSelection()"
                        class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">
                    Confirm
                </button>
                <button type="button" onclick="closeMapModal()"
                        class="flex-1 bg-gray-400 text-white py-2 rounded hover:bg-gray-500 font-bold">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="api-client.js"></script>
    <script src="auth-service.js"></script>
    <script src="trip-service.js"></script>
    <script src="trip-service-api.js"></script>
    <script>
        let currentMatches = [];
        let selectedTrip = null;

        // Check authentication
        window.addEventListener('DOMContentLoaded', async () => {
            if (!AuthService.isAuthenticated()) {
                window.location.href = '/Login-Connected.html';
                return;
            }
        });

        // Get current location
        async function getCurrentLocation(type) {
            try {
                showNotification('Getting location...', 'info');
                const location = await LocationService.getCurrentLocation();

                if (type === 'pickup') {
                    document.getElementById('pickupLat').value = location.latitude;
                    document.getElementById('pickupLng').value = location.longitude;
                    document.getElementById('pickupLocationName').value = `üìç ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`;
                }

                showNotification('‚úì Location set', 'success');
            } catch (error) {
                console.error('Location error:', error);

                // Provide helpful error message
                let errorMsg = 'Could not access location. ';
                if (error.code === 1) {
                    errorMsg += 'Please allow location access in browser permissions.';
                } else if (error.code === 2) {
                    errorMsg += 'Location service unavailable. Please enter coordinates manually.';
                } else if (error.code === 3) {
                    errorMsg += 'Location request timed out. Please enter coordinates manually.';
                } else {
                    errorMsg += 'Please enter coordinates manually (format: latitude, longitude).';
                }

                showNotification(errorMsg, 'error');
            }
        }

        // Handle search
        async function handleSearch(e) {
            if (e) e.preventDefault();

            const pickupLat = parseFloat(document.getElementById('pickupLat').value);
            const pickupLng = parseFloat(document.getElementById('pickupLng').value);
            const dropoffLat = parseFloat(document.getElementById('dropoffLat').value);
            const dropoffLng = parseFloat(document.getElementById('dropoffLng').value);

            // Validate
            if (!pickupLat || !pickupLng) {
                showError('Please set pickup location');
                return;
            }

            if (!dropoffLat || !dropoffLng) {
                showError('Please set dropoff location');
                return;
            }

            clearError();
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            try {
                const response = await TripServiceAPI.findMatches(
                    { type: 'Point', coordinates: [pickupLng, pickupLat] },
                    { type: 'Point', coordinates: [dropoffLng, dropoffLat] },
                    5
                );

                currentMatches = response.matches || [];
                displayResults();

            } catch (error) {
                console.error('Search error:', error);
                showError(error.message || 'Error searching for rides');
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
            }
        }

        // Display results
        function displayResults() {
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('matchCount').textContent = currentMatches.length;

            const grid = document.getElementById('matchesGrid');
            grid.innerHTML = '';

            if (currentMatches.length === 0) {
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }

            document.getElementById('noResults').classList.add('hidden');

            currentMatches.forEach(trip => {
                const card = document.createElement('div');
                card.className = 'match-card bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500';

                const driver = trip.driver;
                const matchPercent = Math.round(trip.matchScore);
                const savings = trip.savings || 0;
                const fare = trip.baseFare || 0;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-lg">
                                ${driver.firstName.charAt(0)}
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">${driver.firstName} ${driver.lastName}</h3>
                                <p class="text-sm text-gray-600">‚≠ê ${driver.rating || 5.0}/5 (${driver.totalRides || 0} rides)</p>
                            </div>
                        </div>
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold text-sm">${matchPercent}% Match</span>
                    </div>

                    <div class="space-y-2 mb-4 text-sm">
                        <div class="flex items-center gap-2 text-gray-700">
                            <i class="fas fa-car text-blue-600 w-4"></i>
                            <span>${trip.vehicle || 'Vehicle'} ‚Ä¢ ${trip.vehicleColor || 'Color'}</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-700">
                            <i class="fas fa-location-dot text-green-600 w-4"></i>
                            <span>${trip.pickupDistance.toFixed(1)} km from pickup</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-700">
                            <i class="fas fa-map text-red-600 w-4"></i>
                            <span>${trip.dropoffDistance.toFixed(1)} km from dropoff</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-700">
                            <i class="fas fa-users text-purple-600 w-4"></i>
                            <span>${trip.occupiedSeats}/${trip.availableSeats} seats taken</span>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg mb-4 flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-600">Base Fare</p>
                            <p class="text-lg font-bold text-gray-900">‚Çπ${fare}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-green-600">You Save</p>
                            <p class="text-lg font-bold text-green-600">‚Çπ${savings}</p>
                        </div>
                    </div>

                    <button onclick="openJoinModal('${trip._id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold transition">
                        Join This Ride
                    </button>
                `;

                grid.appendChild(card);
            });
        }

        // Open join modal
        function openJoinModal(tripId) {
            const trip = currentMatches.find(t => t._id === tripId);
            if (!trip) return;

            selectedTrip = trip;
            const modal = document.getElementById('joinModal');
            const content = document.getElementById('modalContent');

            const fare = Math.round(trip.baseFare * 0.6); // Rider pays 60%

            content.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-700">Driver:</span>
                        <span class="text-gray-900">${trip.driver.firstName} ${trip.driver.lastName}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-700">Vehicle:</span>
                        <span class="text-gray-900">${trip.vehicle} (${trip.vehicleColor})</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-700">Match Score:</span>
                        <span class="text-green-600 font-bold">${Math.round(trip.matchScore)}%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-700">Your Fare:</span>
                        <span class="text-blue-600 font-bold text-lg">‚Çπ${fare}</span>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800 border border-yellow-200">
                        <i class="fas fa-info-circle mr-2"></i>
                        Waiting for driver to accept your request
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('joinModal').classList.add('hidden');
            selectedTrip = null;
        }

        // Confirm join
        async function confirmJoin() {
            if (!selectedTrip) return;

            const btn = document.getElementById('confirmJoinBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="inline-block w-4 h-4 loading-spinner"></span> Joining...';

            try {
                const response = await TripServiceAPI.joinTrip(selectedTrip._id);

                if (response.success) {
                    showNotification('‚úì Request sent! Waiting for driver approval...', 'success');
                    closeModal();
                    setTimeout(() => {
                        window.location.href = 'Dashboard.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Join error:', error);
                showError(error.message || 'Error joining trip');
                btn.disabled = false;
                btn.innerHTML = 'Join Ride';
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                AuthService.logout();
            }
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Clear error
        function clearError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            }[type];

            notification.className = `fixed top-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Map modal variables
        let mapInstance = null;
        let currentMapType = null;
        let selectedMapLat = null;
        let selectedMapLng = null;

        function openMapModal(type) {
            currentMapType = type;
            document.getElementById('mapModal').classList.remove('hidden');

            // Initialize map
            setTimeout(async () => {
                if (mapInstance) {
                    mapInstance.remove();
                }

                // Default to user's current location
                let initialLat = 30.836427;
                let initialLng = 76.960320;

                // Try to get current location first
                try {
                    const location = await LocationService.getCurrentLocation();
                    initialLat = location.latitude;
                    initialLng = location.longitude;
                } catch (e) {
                    // Use default
                }

                mapInstance = L.map('mapContainer').setView([initialLat, initialLng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(mapInstance);

                // Set marker on click
                mapInstance.on('click', function(e) {
                    selectedMapLat = e.latlng.lat;
                    selectedMapLng = e.latlng.lng;

                    // Remove old marker
                    document.querySelectorAll('.leaflet-marker-icon').forEach(marker => {
                        if (marker.parentElement.classList.contains('custom-marker')) {
                            marker.parentElement.remove();
                        }
                    });

                    // Add new marker
                    L.marker([selectedMapLat, selectedMapLng]).addTo(mapInstance);

                    // Show selected coordinates
                    document.getElementById('selectedCoords').textContent =
                        `${selectedMapLat.toFixed(6)}, ${selectedMapLng.toFixed(6)}`;
                });
            }, 100);
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.add('hidden');
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            selectedMapLat = null;
            selectedMapLng = null;
        }

        function confirmMapSelection() {
            if (selectedMapLat === null || selectedMapLng === null) {
                alert('Please select a location on the map');
                return;
            }

            if (currentMapType === 'pickup') {
                document.getElementById('pickupLat').value = selectedMapLat;
                document.getElementById('pickupLng').value = selectedMapLng;
                document.getElementById('pickupLocationName').value =
                    `üìç ${selectedMapLat.toFixed(6)}, ${selectedMapLng.toFixed(6)}`;
            } else if (currentMapType === 'dropoff') {
                document.getElementById('dropoffLat').value = selectedMapLat;
                document.getElementById('dropoffLng').value = selectedMapLng;
                document.getElementById('dropoffLocationName').value =
                    `üìç ${selectedMapLat.toFixed(6)}, ${selectedMapLng.toFixed(6)}`;
            }

            closeMapModal();
            showNotification('‚úì Location selected from map', 'success');
        }
    </script>
</body>
</html>
