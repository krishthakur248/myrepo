<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Pulling - Offer a Ride</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top-color: #3B82F6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .profile-dropdown {
            z-index: 999999 !important;
            position: fixed !important;
        }
        #mapContainer {
            height: 400px;
            border-radius: 8px;
            z-index: 10;
        }
        .map-modal {
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-car text-blue-600 text-2xl"></i>
                <span class="font-bold text-xl">Car Pulling</span>
            </div>
            <div class="flex gap-4 items-center">
                <a href="./Dashboard-Connected.html" class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded">Dashboard</a>
                <!-- Settings Button -->
                <button class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Settings">
                    <i class="fas fa-cog text-blue-600 text-xl"></i>
                </button>
                <!-- Profile Dropdown Button -->
                <div class="relative">
                    <button id="profileBtn" class="flex items-center gap-2 px-3 py-2 rounded-full hover:bg-blue-100 transition-colors z-10 relative">
                        <i class="fas fa-user-circle text-blue-600 text-xl"></i>
                        <i class="fas fa-chevron-down text-blue-600 text-xs"></i>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="profileDropdown" class="profile-dropdown right-5 top-16 w-48 bg-white border border-gray-200 rounded-lg shadow-2xl hidden">
                        <div class="p-3 border-b border-gray-200">
                            <p class="text-sm font-semibold text-gray-800">Profile</p>
                            <p class="text-xs text-gray-600" id="profileEmail">Loading...</p>
                        </div>
                        <a href="#" class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:text-blue-600 hover:bg-blue-50 transition-colors text-sm">
                            <i class="fas fa-user text-sm"></i>
                            My Profile
                        </a>
                        <button onclick="logout()" class="w-full flex items-center gap-2 px-4 py-2 text-red-600 hover:text-red-700 hover:bg-red-50 transition-colors text-sm border-t border-gray-200">
                            <i class="fas fa-sign-out-alt text-sm"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto p-4 mt-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Offer a Ride</h1>
            <p class="text-gray-600">Share your journey and earn money</p>
        </div>

        <!-- Form Container -->
        <div class="bg-white rounded-lg shadow-lg p-8 space-y-6">

            <!-- Error/Success Messages -->
            <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg flex items-start gap-3">
                <i class="fas fa-exclamation-circle mt-0.5"></i>
                <span id="errorText"></span>
            </div>
            <div id="successMessage" class="hidden bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-lg flex items-start gap-3">
                <i class="fas fa-check-circle mt-0.5"></i>
                <span id="successText"></span>
            </div>

            <!-- Trip Form -->
            <form id="tripForm" onsubmit="handleCreateTrip(event)" class="space-y-6">

                <!-- Pickup Location -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-map-pin text-green-600 mr-2"></i>Pickup Location
                    </label>
                    <input type="text" id="pickupLocationName" placeholder="Enter pickup location or click 'Get Current Location'"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                           required>
                    <input type="hidden" id="pickupLat">
                    <input type="hidden" id="pickupLng">
                    <div class="mt-2 flex gap-2">
                        <button type="button" onclick="getCurrentLocation('pickup')"
                                class="text-blue-600 hover:underline text-sm font-medium">
                            <i class="fas fa-location-arrow mr-1"></i>Use Current Location
                        </button>
                        <button type="button" onclick="openMapModal('pickup')"
                                class="text-blue-600 hover:underline text-sm font-medium">
                            <i class="fas fa-map mr-1"></i>Pick on Map
                        </button>
                    </div>
                </div>

                <!-- Dropoff Location -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-map-pin text-red-600 mr-2"></i>Dropoff Location
                    </label>
                    <input type="text" id="dropoffLocationName" placeholder="Enter destination"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                           required>
                    <input type="hidden" id="dropoffLat">
                    <input type="hidden" id="dropoffLng">
                    <small class="text-gray-500">Use address or coordinates (lat,lng)</small>
                    <div class="mt-2">
                        <button type="button" onclick="openMapModal('dropoff')"
                                class="text-blue-600 hover:underline text-sm font-medium">
                            <i class="fas fa-map mr-1"></i>Pick on Map
                        </button>
                    </div>
                </div>

                <!-- Available Seats -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-users mr-2"></i>Available Seats
                        </label>
                        <select id="availableSeats" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" required>
                            <option value="">Select seats</option>
                            <option value="1">1 Seat</option>
                            <option value="2">2 Seats</option>
                            <option value="3">3 Seats</option>
                            <option value="4">4 Seats</option>
                            <option value="5">5+ Seats</option>
                        </select>
                    </div>
                </div>

                <!-- Vehicle Info -->
                <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
                        <i class="fas fa-car"></i>Vehicle Information
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div>
                            <label class="font-bold text-gray-700 block mb-2">Vehicle Type:</label>
                            <div class="flex gap-2">
                                <button type="button" id="vehicleTypeCar" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-300 font-bold text-gray-700 hover:border-blue-500 transition-all flex items-center justify-center gap-2" onclick="selectVehicleType('car')">
                                    <i class="fas fa-car"></i>Car
                                </button>
                                <button type="button" id="vehicleTypeBike" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-300 font-bold text-gray-700 hover:border-blue-500 transition-all flex items-center justify-center gap-2" onclick="selectVehicleType('bike')">
                                    <i class="fas fa-motorcycle"></i>Bike
                                </button>
                                <button type="button" id="vehicleTypeEV" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-300 font-bold text-gray-700 hover:border-blue-500 transition-all flex items-center justify-center gap-2" onclick="selectVehicleType('ev')">
                                    <i class="fas fa-bolt"></i>EV
                                </button>
                            </div>
                            <input type="hidden" id="vehicleTypeSelect">
                        </div>
                        <div>
                            <label class="font-bold text-gray-700 block mb-1">Vehicle Number:</label>
                            <input type="text" id="vehicleNumberInput" placeholder="e.g., ABC-1234" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="createTripBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2 shadow-md">
                    <i class="fas fa-plus"></i>Create Trip
                </button>
            </form>

            <!-- Active Trip Details -->
            <div id="activeTripSection" class="hidden space-y-6 border-t pt-6">

                <!-- Trip Info Card -->
                <div class="bg-green-50 border-2 border-green-200 p-6 rounded-lg">
                    <div class="flex items-start gap-3 mb-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        <div>
                            <h3 class="font-bold text-green-900">Active Trip</h3>
                            <p class="text-green-700 text-sm mt-1">Your ride is live! Share the code with riders</p>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded border-2 border-green-200 mb-4 space-y-3">
                        <div>
                            <p class="text-sm text-gray-600 font-bold">Trip Code:</p>
                            <div class="flex items-center gap-2 mt-2">
                                <input type="text" id="tripCode" readonly
                                       class="flex-1 px-3 py-2 bg-gray-50 border rounded font-bold text-lg"
                                       onclick="copeTripCode()">
                                <button type="button" onclick="copyTripCode()"
                                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    <i class="fas fa-copy"></i>Copy
                                </button>
                            </div>
                        </div>

                        <div>
                            <p class="text-sm text-gray-600 font-bold">Trip Details:</p>
                            <div class="grid grid-cols-2 gap-3 mt-2 text-sm">
                                <div class="bg-blue-50 p-3 rounded">
                                    <p class="text-gray-600">Pickup</p>
                                    <p class="font-bold text-gray-900" id="activeTripPickup">-</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded">
                                    <p class="text-gray-600">Dropoff</p>
                                    <p class="font-bold text-gray-900" id="activeTripDropoff">-</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded">
                                    <p class="text-gray-600">Available Seats</p>
                                    <p class="font-bold text-gray-900" id="activeTripSeats">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rider Requests Section -->
                <div>
                    <h3 class="font-bold text-lg text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-users text-blue-600"></i>Rider Requests
                        <span id="requestCount" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm">0</span>
                    </h3>

                    <div id="riderRequestsList" class="space-y-3">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                            <p>No rider requests yet</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 border-t pt-6">
                    <button type="button" onclick="goToDashboard()"
                            class="flex-1 bg-gray-400 text-white py-3 rounded-lg hover:bg-gray-500 font-bold transition">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </button>
                    <button type="button" onclick="completeActiveTrip()"
                            class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-bold transition">
                        <i class="fas fa-flag-checkered mr-2"></i>Complete Trip
                    </button>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="mt-8 bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg">
            <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                <i class="fas fa-info-circle"></i>How it Works
            </h3>
            <ol class="text-blue-800 space-y-2 ml-6 list-decimal">
                <li>Enter your pickup and dropoff locations</li>
                <li>Set available seats (riders pay based on distance: ‚Çπ10 per km)</li>
                <li>Click "Create Trip" to publish your offer</li>
                <li>Riders will see your trip and request to join</li>
                <li>Accept riders and start earning!</li>
            </ol>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center map-modal">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold"><i class="fas fa-map mr-2"></i>Select Location on Map</h2>
                <button type="button" onclick="closeMapModal()" class="text-gray-600 hover:text-gray-900 text-2xl">
                    &times;
                </button>
            </div>
            <div class="p-4">
                <div id="mapContainer"></div>
                <p class="text-sm text-gray-600 mt-3 text-center">Click on the map to select location</p>
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                    <p class="text-sm font-semibold">Selected: <span id="selectedCoords" class="text-blue-600">Click on map</span></p>
                </div>
            </div>
            <div class="flex gap-2 p-4 border-t">
                <button type="button" onclick="confirmMapSelection()"
                        class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">
                    Confirm
                </button>
                <button type="button" onclick="closeMapModal()"
                        class="flex-1 bg-gray-400 text-white py-2 rounded hover:bg-gray-500 font-bold">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl h-4/5 flex flex-col">
            <!-- Chat Header -->
            <div class="flex justify-between items-center p-4 border-b bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                <div>
                    <h2 class="text-xl font-bold"><i class="fas fa-comments mr-2"></i>Chat with <span id="chatRiderName">Rider</span></h2>
                    <p class="text-sm text-blue-100">Trip ID: <span id="chatTripId" class="font-mono"></span></p>
                </div>
                <button onclick="closeChatModal()" class="text-white hover:bg-blue-600 p-2 rounded-full">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Messages Container -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <div class="text-center text-gray-500 text-sm">
                    <i class="fas fa-comments text-4xl text-gray-300 mb-2"></i>
                    <p>No messages yet. Start the conversation!</p>
                </div>
            </div>

            <!-- Message Input -->
            <div class="border-t bg-white p-4 flex gap-2">
                <input type="text" id="chatMessageInput" placeholder="Type your message..."
                       class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                       onkeypress="handleChatKeyPress(event)">
                <button onclick="sendChatMessage()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition-colors">
                    <i class="fas fa-paper-plane mr-1"></i>Send
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="api-client.js"></script>
    <script src="auth-service.js"></script>
    <script src="trip-service.js"></script>
    <script src="trip-service-api.js"></script>
    <script src="message-service.js"></script>
    <script src="notification-manager.js"></script>
    <script>
        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', async () => {
            if (!AuthService.isAuthenticated()) {
                window.location.href = '/Login-Connected.html';
                return;
            }

            // Check if there's an active trip BEFORE doing other initialization
            const activeTripId = localStorage.getItem('activeTrip');
            if (activeTripId) {
                console.log('[DEBUG] Found active trip in localStorage:', activeTripId);
                // Preemptively hide the form while loading
                document.getElementById('tripForm').classList.add('hidden');
            }

            populateProfileEmail();
            loadUserInfo();
            await loadActiveTrip(); // Check if driver has an active trip

            // Initialize notification system
            NotificationManager.initializeSocket();
            const user = AuthService.getCurrentUser();
            if (user && user.id) {
                NotificationManager.joinUserRoom(user.id);
            }

            // Setup Socket.io listeners for real-time message updates
            setupSocketListeners();
        });

        // Setup Socket.io listeners for messages
        function setupSocketListeners() {
            // Use a small delay to ensure NotificationManager socket is initialized
            setTimeout(() => {
                const socket = io('http://localhost:5001', {
                    auth: {
                        token: apiClient.getToken()
                    }
                });

                // Store socket globally for access in other functions
                window.driverSocket = socket;

                const user = AuthService.getCurrentUser();

                // Emit event to join user-specific room for notifications
                if (user && user._id) {
                    socket.emit('join-user-room', { userId: user._id });
                    console.log('[DEBUG] Driver joined user room:', user._id);
                }

                // Listen for new messages in real-time
                socket.on('new-message', async (data) => {
                    console.log('[DEBUG] Driver received new message:', data);
                    // If the message is for the current open conversation, refresh messages
                    if (currentChatTripId && data.tripId === currentChatTripId) {
                        console.log('[DEBUG] Message is for current chat, refreshing...');
                        await loadChatMessages();
                    }
                });

                // Also listen for notification events (backup)
                socket.on('notification', async (data) => {
                    console.log('[DEBUG] Driver received notification:', data);
                    if (data.type === 'new-message' && currentChatTripId && data.tripId === currentChatTripId) {
                        console.log('[DEBUG] Notification is for current chat, refreshing...');
                        await loadChatMessages();
                    }
                });

                // Listen for rider location updates (in case we need to track rider movement too)
                socket.on('location-updated', (data) => {
                    console.log('[DEBUG] Location update received:', data);
                    // This might contain rider location updates or driver location from Socket.io
                    if (window.currentActiveTrip && data.userId) {
                        // Store location updates for later use
                        if (!window.locationUpdates) {
                            window.locationUpdates = {};
                        }
                        window.locationUpdates[data.userId] = {
                            lat: data.latitude,
                            lng: data.longitude,
                            timestamp: data.timestamp
                        };

                        // If this is the driver's own location (from driver's GPS), update currentActiveTrip
                        const currentUser = AuthService.getCurrentUser();
                        if (currentUser && currentUser.id === data.userId && window.currentActiveTrip && window.currentActiveTrip.driver) {
                            window.currentActiveTrip.driver.currentLocation = {
                                type: 'Point',
                                coordinates: [data.longitude, data.latitude]
                            };
                            console.log('[LOCATION] Updated currentActiveTrip driver location:', window.currentActiveTrip.driver.currentLocation);
                        }

                        console.log('[DEBUG] Stored location update for user:', data.userId);
                    }
                });

                // Listen for driver location broadcasts from backend (driver can also receive their own location update)
                socket.on('driver-location-update', (data) => {
                    console.log('[DEBUG] Driver location update received:', data);

                    // Check if this is our active trip
                    if (window.currentActiveTrip && data.tripId === window.currentActiveTrip._id) {
                        // Update our own location in the trip object
                        // Use lat/lng from the broadcast (not latitude/longitude)
                        window.currentActiveTrip.driver.currentLocation = {
                            type: 'Point',
                            coordinates: [data.lng, data.lat]
                        };
                        console.log('[LOCATION] ‚úÖ Updated driver location from driver-location-update event:', window.currentActiveTrip.driver.currentLocation);
                    }

                    // Also store all driver location updates in window.driverLocations for map updates
                    if (!window.driverLocations) {
                        window.driverLocations = {};
                    }
                    window.driverLocations[data.tripId] = {
                        lat: data.lat,
                        lng: data.lng,
                        timestamp: data.timestamp,
                        driverId: data.driverId
                    };
                    console.log('[LOCATION] Stored in window.driverLocations[' + data.tripId + ']:', window.driverLocations[data.tripId]);
                });
            }, 500);
        }

        // Populate profile email in dropdown
        function populateProfileEmail() {
            const user = AuthService.getCurrentUser();
            if (user) {
                const profileEmailEl = document.getElementById('profileEmail');
                if (profileEmailEl) {
                    profileEmailEl.textContent = user.email || user.username || 'User';
                }
            }
        }

        // Profile dropdown toggle
        document.addEventListener('DOMContentLoaded', () => {
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');

            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }
        });

        // Load user vehicle info
        async function loadUserInfo() {
            try {
                const user = AuthService.getCurrentUser();

                // Populate vehicle type buttons
                if (user && user.vehicle) {
                    selectVehicleType(user.vehicle.toLowerCase());
                }

                // Populate vehicle number input
                const vehicleNumberInput = document.getElementById('vehicleNumberInput');
                if (user && user.vehicleNumber) {
                    vehicleNumberInput.value = user.vehicleNumber;
                }

                // Add event listeners to save changes - but only when user explicitly makes changes
                const vehicleTypeButtons = document.querySelectorAll('[id^="vehicleType"]');
                vehicleTypeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Delay the save to ensure value is updated
                        setTimeout(saveVehicleInfo, 100);
                    });
                });

                vehicleNumberInput.addEventListener('blur', saveVehicleInfo);
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Select vehicle type
        function selectVehicleType(type) {
            // Update hidden input value
            document.getElementById('vehicleTypeSelect').value = type;

            // Update button styles
            document.getElementById('vehicleTypeCar').classList.remove('border-blue-500', 'text-white', 'bg-blue-600');
            document.getElementById('vehicleTypeBike').classList.remove('border-blue-500', 'text-white', 'bg-blue-600');
            document.getElementById('vehicleTypeEV').classList.remove('border-blue-500', 'text-white', 'bg-blue-600');

            document.getElementById('vehicleTypeCar').classList.add('border-gray-300', 'text-gray-700', 'bg-white');
            document.getElementById('vehicleTypeBike').classList.add('border-gray-300', 'text-gray-700', 'bg-white');
            document.getElementById('vehicleTypeEV').classList.add('border-gray-300', 'text-gray-700', 'bg-white');

            // Highlight selected button
            const buttonId = `vehicleType${type.charAt(0).toUpperCase() + type.slice(1)}`;
            if (type === 'ev') {
                document.getElementById('vehicleTypeEV').classList.remove('border-gray-300', 'text-gray-700', 'bg-white');
                document.getElementById('vehicleTypeEV').classList.add('border-blue-500', 'text-white', 'bg-blue-600');
            } else if (type === 'car') {
                document.getElementById('vehicleTypeCar').classList.remove('border-gray-300', 'text-gray-700', 'bg-white');
                document.getElementById('vehicleTypeCar').classList.add('border-blue-500', 'text-white', 'bg-blue-600');
            } else if (type === 'bike') {
                document.getElementById('vehicleTypeBike').classList.remove('border-gray-300', 'text-gray-700', 'bg-white');
                document.getElementById('vehicleTypeBike').classList.add('border-blue-500', 'text-white', 'bg-blue-600');
            }
        }

        // Save vehicle information
        async function saveVehicleInfo() {
            try {
                const vehicle = document.getElementById('vehicleTypeSelect').value;
                const vehicleNumber = document.getElementById('vehicleNumberInput').value;

                // Only save if at least one field is filled
                if (!vehicle && !vehicleNumber) {
                    return; // Silently return if both are empty
                }

                // If only one is filled, show warning but don't block
                if (!vehicle || !vehicleNumber) {
                    console.warn('Vehicle info incomplete - some fields are empty');
                    return; // Don't save incomplete data
                }

                const response = await AuthService.updateProfile({
                    vehicle,
                    vehicleNumber
                });

                if (response) {
                    showNotification('‚úì Vehicle information updated', 'success');
                    // Update localStorage
                    const user = AuthService.getCurrentUser();
                    user.vehicle = vehicle;
                    user.vehicleNumber = vehicleNumber;
                    localStorage.setItem('user', JSON.stringify(user));
                }
            } catch (error) {
                console.error('Error saving vehicle info:', error);
                showError(error.message || 'Error updating vehicle information');
            }
        }

        // Load active trip if exists
        async function loadActiveTrip() {
            try {
                const activeTripId = localStorage.getItem('activeTrip');
                console.log('[DEBUG] loadActiveTrip called, activeTrip:', activeTripId);

                if (!activeTripId) {
                    console.log('[DEBUG] No active trip in localStorage');
                    return; // No active trip
                }

                const response = await TripServiceAPI.getTripDetails(activeTripId);
                console.log('[DEBUG] getTripDetails response:', response);

                if (response && response.trip) {
                    const trip = response.trip;

                    // STORE TRIP GLOBALLY FOR USE IN MAP FUNCTIONS
                    window.currentActiveTrip = trip;

                    console.log('[DEBUG] Trip details loaded, status:', trip.status);

                    // Check if trip is still active
                    if (trip.status !== 'active') {
                        console.log('[DEBUG] Trip is not active, removing from storage');
                        localStorage.removeItem('activeTrip');
                        localStorage.removeItem('activeTripCode');
                        // Show form if trip is not active
                        document.getElementById('tripForm').classList.remove('hidden');
                        document.getElementById('activeTripSection').classList.add('hidden');
                        return;
                    }

                    console.log('[DEBUG] Trip is active, showing active trip section');

                    // Join trip room for real-time notifications
                    NotificationManager.joinTripRoom(trip._id);

                    // **NEW: Start location tracking for driver to send real-time location to riders**
                    LocationService.startLocationTracking();
                    console.log('[DEBUG] Location tracking started for active trip');

                    // Show active trip section and hide form
                    document.getElementById('tripForm').classList.add('hidden');
                    document.getElementById('activeTripSection').classList.remove('hidden');

                    // Display trip details
                    document.getElementById('tripCode').value = trip.tripCode;

                    // Extract coordinates - handle both flat and nested GeoJSON formats
                    let pickupCoords = trip.pickupLocation.coordinates;
                    let dropoffCoords = trip.dropoffLocation.coordinates;

                    // If coordinates is a GeoJSON object, extract the array
                    if (pickupCoords && typeof pickupCoords === 'object' && pickupCoords.coordinates) {
                        pickupCoords = pickupCoords.coordinates;
                    }
                    if (dropoffCoords && typeof dropoffCoords === 'object' && dropoffCoords.coordinates) {
                        dropoffCoords = dropoffCoords.coordinates;
                    }

                    // Safety check before calling toFixed
                    if (pickupCoords && Array.isArray(pickupCoords) && pickupCoords.length >= 2) {
                        document.getElementById('activeTripPickup').textContent =
                            `üìç ${parseFloat(pickupCoords[1]).toFixed(4)}, ${parseFloat(pickupCoords[0]).toFixed(4)}`;
                    } else {
                        document.getElementById('activeTripPickup').textContent = 'üìç Location unavailable';
                    }

                    if (dropoffCoords && Array.isArray(dropoffCoords) && dropoffCoords.length >= 2) {
                        document.getElementById('activeTripDropoff').textContent =
                            `üìç ${parseFloat(dropoffCoords[1]).toFixed(4)}, ${parseFloat(dropoffCoords[0]).toFixed(4)}`;
                    } else {
                        document.getElementById('activeTripDropoff').textContent = 'üìç Location unavailable';
                    }

                    document.getElementById('activeTripSeats').textContent = trip.availableSeats;

                    // Display rider requests
                    if (trip.riders && trip.riders.length > 0) {
                        console.log('[DEBUG] Displaying rider requests, count:', trip.riders.length);
                        displayRiderRequests(trip.riders, trip);
                    } else {
                        console.log('[DEBUG] No rider requests yet');
                        document.getElementById('riderRequestsList').innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                                <p>No rider requests yet</p>
                            </div>
                        `;
                    }
                } else {
                    console.log('[DEBUG] No trip data in response, clearing localStorage');
                    localStorage.removeItem('activeTrip');
                    localStorage.removeItem('activeTripCode');
                    document.getElementById('tripForm').classList.remove('hidden');
                    document.getElementById('activeTripSection').classList.add('hidden');
                }
            } catch (error) {
                console.error('[ERROR] Error loading active trip:', error);
                // On error, clear the active trip and show form
                localStorage.removeItem('activeTrip');
                localStorage.removeItem('activeTripCode');
                document.getElementById('tripForm').classList.remove('hidden');
                document.getElementById('activeTripSection').classList.add('hidden');
            }
        }

        // Display rider requests
        function displayRiderRequests(riders, trip) {
            document.getElementById('requestCount').textContent = riders.length;

            if (riders.length === 0) {
                document.getElementById('riderRequestsList').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                        <p>No rider requests yet</p>
                    </div>
                `;
                return;
            }

            // Get driver's location from active trip
            let driverLat = 30.836427;
            let driverLng = 76.960320;

            // Use trip's driver location if available
            if (trip && trip.driverLocation) {
                if (Array.isArray(trip.driverLocation.coordinates)) {
                    driverLng = parseFloat(trip.driverLocation.coordinates[0]);
                    driverLat = parseFloat(trip.driverLocation.coordinates[1]);
                } else if (trip.driverLocation.lng && trip.driverLocation.lat) {
                    driverLat = parseFloat(trip.driverLocation.lat);
                    driverLng = parseFloat(trip.driverLocation.lng);
                }
            }

            const requestsList = riders.map(rider => {
                // Extract coordinates
                const getCoords = (location) => {
                    if (!location) return { lat: null, lng: null };

                    if (location.coordinates?.coordinates && Array.isArray(location.coordinates.coordinates)) {
                        return {
                            lat: parseFloat(location.coordinates.coordinates[1]),
                            lng: parseFloat(location.coordinates.coordinates[0])
                        };
                    }
                    if (Array.isArray(location.coordinates) && location.coordinates.length === 2) {
                        return {
                            lat: parseFloat(location.coordinates[1]),
                            lng: parseFloat(location.coordinates[0])
                        };
                    }
                    return { lat: null, lng: null };
                };

                const pickupCoords = getCoords(rider.pickupPoint);
                const dropoffCoords = getCoords(rider.dropoffPoint || rider.dropoffLocation);
                console.log(`[DEBUG] Rider pickup point:`, rider.pickupPoint, `Extracted coords:`, pickupCoords);
                console.log(`[DEBUG] Rider dropoff point:`, rider.dropoffPoint || rider.dropoffLocation, `Extracted coords:`, dropoffCoords);
                const riderName = `${rider.riderId?.firstName || 'Rider'} ${rider.riderId?.lastName || ''}`;
                const tripId = localStorage.getItem('activeTrip');
                // Ensure riderId is a string ID
                const riderId = typeof rider.riderId === 'string' ? rider.riderId : (rider.riderId?._id || rider.riderId);
                const riderStatus = rider.status || 'matched';

                // Calculate distance between driver and rider pickup
                let distance = 'N/A';
                if (pickupCoords.lat && pickupCoords.lng) {
                    distance = calculateDistance(driverLat, driverLng, pickupCoords.lat, pickupCoords.lng).toFixed(1) + ' km';
                }

                // Different UI based on rider status
                let actionButtonsHTML = '';
                if (riderStatus === 'confirmed') {
                    // Accepted rider - show message button, map button, and status badge
                    actionButtonsHTML = `
                        <div class="flex items-center gap-3">
                            <span class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm font-bold border-2 border-green-400 flex items-center gap-2">
                                <i class="fas fa-check-circle"></i>Accepted
                            </span>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium" onclick="showRiderMap('${rider._id}', ${pickupCoords.lat}, ${pickupCoords.lng}, ${dropoffCoords.lat}, ${dropoffCoords.lng}, '${riderName}')">
                                <i class="fas fa-map-location-dot mr-1"></i>Map
                            </button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium" onclick="openChat('${riderId}', '${riderName}', '${tripId}')">
                                <i class="fas fa-comments mr-1"></i>Message
                            </button>
                        </div>
                    `;
                } else {
                    // Pending rider - show distance, map, accept, and reject buttons
                    actionButtonsHTML = `
                        <div class="flex gap-2 flex-wrap">
                            <button class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium" onclick="showRiderMap('${rider._id}', ${pickupCoords.lat}, ${pickupCoords.lng}, ${dropoffCoords.lat}, ${dropoffCoords.lng}, '${riderName}')">
                                <i class="fas fa-map mr-1"></i>Map
                            </button>
                            <button class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium" onclick="acceptRiderRequest('${riderId}', '${riderName}', '${tripId}')">
                                <i class="fas fa-check mr-1"></i>Accept
                            </button>
                            <button class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium" onclick="rejectRiderRequest('${riderId}', '${riderName}', '${tripId}')">
                                <i class="fas fa-times mr-1"></i>Reject
                            </button>
                        </div>
                    `;
                }

                return `
                <div class="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg flex justify-between items-center transition-all duration-300 ${riderStatus === 'confirmed' ? 'border-green-400 bg-green-50' : ''}">
                    <div>
                        <h4 class="font-bold text-gray-900">${riderName}</h4>
                        <p class="text-sm text-gray-600 mt-1">Fare: ‚Çπ${rider.fare || 'TBD'}</p>
                    </div>
                    ${actionButtonsHTML}
                </div>
            `;
            }).join('');

            document.getElementById('riderRequestsList').innerHTML = requestsList;
        }

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Show map with driver and rider locations
        function showRiderMap(riderId, riderLat, riderLng, destLat, destLng, riderName) {
            console.log(`Map Debug - Rider Pickup: Lat=${riderLat}, Lng=${riderLng}`);
            console.log(`Map Debug - Rider Destination: Lat=${destLat}, Lng=${destLng}`);
            console.log(`[MAP] showRiderMap called - current trip:`, window.currentActiveTrip);
            console.log(`[MAP] window.driverLocations:`, window.driverLocations);

            // Get driver's actual LIVE location from the stored trip
            let driverLat = null;
            let driverLng = null;

            if (window.currentActiveTrip) {
                const trip = window.currentActiveTrip;
                console.log(`[MAP] Trip ID: ${trip._id}, Driver object exists: ${!!trip.driver}, Driver.currentLocation:`, trip.driver?.currentLocation);

                // PRIMARY: Get driver's current location from their profile (live GPS location)
                if (trip.driver && trip.driver.currentLocation && trip.driver.currentLocation.coordinates) {
                    driverLng = parseFloat(trip.driver.currentLocation.coordinates[0]);
                    driverLat = parseFloat(trip.driver.currentLocation.coordinates[1]);
                    console.log(`‚úÖ Map Debug - Driver Live Location from trip.driver.currentLocation: Lat=${driverLat}, Lng=${driverLng}`);
                }
                // SECONDARY: Try trip's stored driverLocation if available
                else if (trip.driverLocation && trip.driverLocation.coordinates) {
                    if (Array.isArray(trip.driverLocation.coordinates)) {
                        driverLng = parseFloat(trip.driverLocation.coordinates[0]);
                        driverLat = parseFloat(trip.driverLocation.coordinates[1]);
                        console.log(`‚ö†Ô∏è Map Debug - Driver Location from trip.driverLocation: Lat=${driverLat}, Lng=${driverLng}`);
                    } else if (trip.driverLocation.lng && trip.driverLocation.lat) {
                        driverLat = parseFloat(trip.driverLocation.lat);
                        driverLng = parseFloat(trip.driverLocation.lng);
                        console.log(`‚ö†Ô∏è Map Debug - Driver Location from trip.driverLocation (lat/lng): Lat=${driverLat}, Lng=${driverLng}`);
                    }
                }
                // TERTIARY: Check window.driverLocations for real-time Socket.io updates
                else if (window.driverLocations && window.driverLocations[trip._id]) {
                    driverLat = window.driverLocations[trip._id].lat;
                    driverLng = window.driverLocations[trip._id].lng;
                    console.log(`‚ö†Ô∏è Map Debug - Driver Location from window.driverLocations (Socket.io): Lat=${driverLat}, Lng=${driverLng}`);
                }
                // DO NOT fallback to pickup location - that's the rider's location, not driver's
            }

            // Validate driver location
            if (driverLat === null || driverLng === null || isNaN(driverLat) || isNaN(driverLng)) {
                console.warn(`‚ö†Ô∏è Map Debug - Driver location unavailable or invalid: Lat=${driverLat}, Lng=${driverLng}`);
                driverLat = null;
                driverLng = null;
            }

            // If still no driver location, store a flag to fetch it later
            const driverLocationUnavailable = (driverLat === null || driverLng === null);
            if (driverLocationUnavailable) {
                console.warn(`‚ö†Ô∏è Driver location will be fetched from live tracking if available`);
            }

            // Create map modal if it doesn't exist
            if (!document.getElementById('riderMapModal')) {
                const mapModal = document.createElement('div');
                mapModal.id = 'riderMapModal';
                mapModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                mapModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-2xl w-11/12 h-5/6 flex flex-col">
                        <div class="flex justify-between items-center p-4 border-b">
                            <h2 class="text-xl font-bold">Trip Route Map - ${riderName}</h2>
                            <div class="text-xs text-gray-600">
                                üöó Driver | üìç Pickup: ${riderLat.toFixed(4)}, ${riderLng.toFixed(4)} | üèÅ Destination: ${destLat.toFixed(4)}, ${destLng.toFixed(4)}
                            </div>
                            <button onclick="closeRiderMap()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div id="riderMapContainer" class="flex-1" style="height: 100%; border-radius: 0 0 8px 8px;"></div>
                    </div>
                `;
                document.body.appendChild(mapModal);
            }

            document.getElementById('riderMapModal').classList.remove('hidden');
            document.getElementById('riderMapModal').style.display = 'flex';

            // Initialize map
            setTimeout(() => {
                // Validate rider coordinates (required)
                if (!riderLat || !riderLng || isNaN(riderLat) || isNaN(riderLng)) {
                    showNotification('‚ùå Error: Rider pickup location unavailable', 'error');
                    console.error('Invalid rider coordinates:', { riderLat, riderLng });
                    closeRiderMap();
                    return;
                }

                // Remove old map instance if exists
                if (window.riderMapInstance) {
                    window.riderMapInstance.remove();
                }

                // Calculate center based on available locations
                // Include driver location if available, otherwise center on rider pickup
                let centerLat = riderLat;
                let centerLng = riderLng;

                if (driverLat !== null && driverLng !== null && !isNaN(driverLat) && !isNaN(driverLng)) {
                    centerLat = (driverLat + riderLat) / 2;
                    centerLng = (driverLng + riderLng) / 2;
                    console.log(`Map centered between driver and rider: Lat=${centerLat}, Lng=${centerLng}`);
                } else {
                    console.warn(`Map centered on rider pickup (driver location invalid): Lat=${centerLat}, Lng=${centerLng}`);
                }

                window.riderMapInstance = L.map('riderMapContainer').setView([centerLat, centerLng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(window.riderMapInstance);

                // Add driver marker (green) - ONLY if driver location is valid
                if (driverLat !== null && driverLng !== null && !isNaN(driverLat) && !isNaN(driverLng)) {
                    L.marker([driverLat, driverLng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(window.riderMapInstance).bindPopup('<div class="font-bold">üöó Driver<br/>Live Location</div>');
                    console.log(`‚úÖ Driver marker added: Lat=${driverLat}, Lng=${driverLng}`);
                } else {
                    console.warn('‚ö†Ô∏è Driver marker NOT added - location unavailable');
                }

                // Add rider pickup marker (blue) - This is where the rider wants to be picked up
                L.marker([riderLat, riderLng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(window.riderMapInstance).bindPopup(`<div class="font-bold">üìç ${riderName}<br/>Pickup Point</div>`);

                // Add rider destination marker (orange/red) - This is where the rider wants to go
                if (destLat && destLng) {
                    L.marker([destLat, destLng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(window.riderMapInstance).bindPopup(`<div class="font-bold">üèÅ ${riderName}<br/>Destination</div>`);
                }

                // Draw line from driver to pickup location to destination (only if driver location valid)
                if (driverLat !== null && driverLng !== null && !isNaN(driverLat) && !isNaN(driverLng)) {
                    L.polyline(
                        destLat && destLng
                            ? [[driverLat, driverLng], [riderLat, riderLng], [destLat, destLng]]
                            : [[driverLat, driverLng], [riderLat, riderLng]],
                        { color: 'blue', weight: 2, opacity: 0.7, dashArray: '5, 5' }
                    ).addTo(window.riderMapInstance);

                    // Calculate and display distance to pickup
                    const distance = calculateDistance(driverLat, driverLng, riderLat, riderLng);
                    const distanceLabel = document.createElement('div');
                    distanceLabel.className = 'absolute top-4 left-4 bg-white px-4 py-2 rounded-lg shadow-lg z-40 font-bold text-blue-600';
                    distanceLabel.textContent = `üöó‚Üíüìç ${distance.toFixed(1)} km`;
                    document.getElementById('riderMapModal').querySelector('.flex-col').appendChild(distanceLabel);

                    // Calculate and display total trip distance if destination exists
                    if (destLat && destLng) {
                        const tripDistance = calculateDistance(riderLat, riderLng, destLat, destLng);
                        const tripLabel = document.createElement('div');
                        tripLabel.className = 'absolute top-16 left-4 bg-white px-4 py-2 rounded-lg shadow-lg z-40 font-bold text-red-600';
                        tripLabel.textContent = `üìç‚ÜíüèÅ ${tripDistance.toFixed(1)} km`;
                        document.getElementById('riderMapModal').querySelector('.flex-col').appendChild(tripLabel);
                    }
                }

                // Store current driver marker and enable real-time updates (if driver location available)
                if (driverLat !== null && driverLng !== null && !isNaN(driverLat) && !isNaN(driverLng)) {
                    window.riderMapDriverMarker = L.marker([driverLat, driverLng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    });
                    window.riderMapDriverMarker.addTo(window.riderMapInstance);

                    // Set up real-time driver location updates
                    window.riderMapUpdateInterval = setInterval(() => {
                        // Get latest trip data - driver location might have been updated via socket
                        if (window.currentActiveTrip && window.currentActiveTrip.driver && window.currentActiveTrip.driver.currentLocation) {
                            const newDriverLat = window.currentActiveTrip.driver.currentLocation.coordinates[1];
                            const newDriverLng = window.currentActiveTrip.driver.currentLocation.coordinates[0];

                            // Update driver marker
                            if (window.riderMapDriverMarker) {
                                window.riderMapDriverMarker.setLatLng([newDriverLat, newDriverLng]);
                            }
                        }
                    }, 1000); // Update every 1 second
                }
            }, 100);
        }

        function closeRiderMap() {
            const modal = document.getElementById('riderMapModal');
            if (modal) {
                modal.style.display = 'none';
                if (window.riderMapInstance) {
                    window.riderMapInstance.remove();
                    window.riderMapInstance = null;
                }
                // Clear update interval
                if (window.riderMapUpdateInterval) {
                    clearInterval(window.riderMapUpdateInterval);
                    window.riderMapUpdateInterval = null;
                }
            }
        }


        // Complete active trip
        async function completeActiveTrip() {
            if (!confirm('Are you sure you want to complete this trip?')) return;

            try {
                const activeTripId = localStorage.getItem('activeTrip');
                if (!activeTripId) {
                    showError('No active trip found');
                    return;
                }

                await TripServiceAPI.completeTrip(activeTripId, []);

                // **NEW: Stop location tracking when trip ends**
                LocationService.stopLocationTracking();
                console.log('[DEBUG] Location tracking stopped');

                // Clear active trip
                localStorage.removeItem('activeTrip');
                localStorage.removeItem('activeTripCode');

                // Show form and hide trip section
                document.getElementById('tripForm').classList.remove('hidden');
                document.getElementById('activeTripSection').classList.add('hidden');

                // Reset form
                document.getElementById('tripForm').reset();

                showNotification('‚úì Trip completed successfully!', 'success');
            } catch (error) {
                console.error('Error completing trip:', error);
                showError(error.message || 'Error completing trip');
            }
        }

        // Get current location
        async function getCurrentLocation(type) {
            try {
                showNotification('Getting location...', 'info');
                const location = await LocationService.getCurrentLocation();

                if (type === 'pickup') {
                    document.getElementById('pickupLat').value = location.latitude;
                    document.getElementById('pickupLng').value = location.longitude;
                    document.getElementById('pickupLocationName').value = `üìç ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`;
                } else if (type === 'dropoff') {
                    document.getElementById('dropoffLat').value = location.latitude;
                    document.getElementById('dropoffLng').value = location.longitude;
                    document.getElementById('dropoffLocationName').value = `üìç ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`;
                }

                showNotification('‚úì Location set', 'success');
            } catch (error) {
                console.error('Location error:', error);

                // Provide helpful error message
                let errorMsg = 'Could not access location. ';
                if (error.code === 1) {
                    errorMsg += 'Please allow location access in browser permissions.';
                } else if (error.code === 2) {
                    errorMsg += 'Location service unavailable. Please enter coordinates manually.';
                } else if (error.code === 3) {
                    errorMsg += 'Location request timed out. Please enter coordinates manually.';
                } else {
                    errorMsg += 'Please enter coordinates manually (format: latitude, longitude).';
                }

                showNotification(errorMsg, 'error');
            }
        }

        // Handle create trip
        async function handleCreateTrip(e) {
            e.preventDefault();
            clearMessages();

            const pickupLat = parseFloat(document.getElementById('pickupLat').value);
            const pickupLng = parseFloat(document.getElementById('pickupLng').value);
            const dropoffLat = parseFloat(document.getElementById('dropoffLat').value);
            const dropoffLng = parseFloat(document.getElementById('dropoffLng').value);
            const availableSeats = parseInt(document.getElementById('availableSeats').value);

            // Validate coordinates
            if (!pickupLat || !pickupLng) {
                showError('Please set pickup location with valid coordinates');
                return;
            }

            if (!dropoffLat || !dropoffLng) {
                showError('Please set dropoff location with valid coordinates');
                return;
            }

            if (!availableSeats || availableSeats < 1) {
                showError('Please select number of available seats');
                return;
            }

            const createTripBtn = document.getElementById('createTripBtn');
            createTripBtn.disabled = true;
            createTripBtn.innerHTML = '<span class="inline-block w-4 h-4 loading-spinner"></span> Creating...';

            try {
                console.log('Creating trip with:', {
                    pickupLat, pickupLng, dropoffLat, dropoffLng,
                    availableSeats
                });

                const response = await TripServiceAPI.startTrip(
                    [pickupLng, pickupLat],
                    [dropoffLng, dropoffLat],
                    availableSeats,
                    null,
                    null
                );

                console.log('Trip response:', response);

                // The API returns success: true and trip object
                if (response && response.success && response.trip) {
                    const trip = response.trip;

                    // Hide form and show active trip section
                    document.getElementById('tripForm').classList.add('hidden');
                    document.getElementById('activeTripSection').classList.remove('hidden');

                    // Store active trip ID
                    localStorage.setItem('activeTrip', trip._id);
                    localStorage.setItem('activeTripCode', trip.tripCode);

                    // Display trip details
                    document.getElementById('tripCode').value = trip.tripCode;

                    // Extract coordinates - handle both flat and nested GeoJSON formats
                    let pickupCoords = trip.pickupLocation.coordinates;
                    let dropoffCoords = trip.dropoffLocation.coordinates;

                    // If coordinates is a GeoJSON object, extract the array
                    if (pickupCoords && typeof pickupCoords === 'object' && pickupCoords.coordinates) {
                        pickupCoords = pickupCoords.coordinates;
                    }
                    if (dropoffCoords && typeof dropoffCoords === 'object' && dropoffCoords.coordinates) {
                        dropoffCoords = dropoffCoords.coordinates;
                    }

                    // Safety check before calling toFixed
                    if (pickupCoords && Array.isArray(pickupCoords) && pickupCoords.length >= 2) {
                        document.getElementById('activeTripPickup').textContent =
                            `üìç ${parseFloat(pickupCoords[1]).toFixed(4)}, ${parseFloat(pickupCoords[0]).toFixed(4)}`;
                    } else {
                        document.getElementById('activeTripPickup').textContent = 'üìç Location unavailable';
                    }

                    if (dropoffCoords && Array.isArray(dropoffCoords) && dropoffCoords.length >= 2) {
                        document.getElementById('activeTripDropoff').textContent =
                            `üìç ${parseFloat(dropoffCoords[1]).toFixed(4)}, ${parseFloat(dropoffCoords[0]).toFixed(4)}`;
                    } else {
                        document.getElementById('activeTripDropoff').textContent = 'üìç Location unavailable';
                    }

                    document.getElementById('activeTripSeats').textContent = trip.availableSeats;
                    document.getElementById('riderRequestsList').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                            <p>No rider requests yet</p>
                        </div>
                    `;

                    showNotification('‚úì Trip created successfully!', 'success');
                } else if (response && response.trip) {
                    // Handle case where API returns trip but no success flag
                    const trip = response.trip;

                    document.getElementById('tripForm').classList.add('hidden');
                    document.getElementById('activeTripSection').classList.remove('hidden');

                    localStorage.setItem('activeTrip', trip._id);
                    localStorage.setItem('activeTripCode', trip.tripCode);

                    document.getElementById('tripCode').value = trip.tripCode;
                    document.getElementById('activeTripPickup').textContent =
                        `üìç ${trip.pickupLocation.coordinates[1].toFixed(4)}, ${trip.pickupLocation.coordinates[0].toFixed(4)}`;
                    document.getElementById('activeTripDropoff').textContent =
                        `üìç ${trip.dropoffLocation.coordinates[1].toFixed(4)}, ${trip.dropoffLocation.coordinates[0].toFixed(4)}`;
                    document.getElementById('activeTripSeats').textContent = trip.availableSeats;
                    document.getElementById('riderRequestsList').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                            <p>No rider requests yet</p>
                        </div>
                    `;

                    showNotification('‚úì Trip created successfully!', 'success');
                } else {
                    throw new Error('Unexpected response format from server');
                }
            } catch (error) {
                console.error('Error creating trip:', error);
                const errorMsg = error.message || 'Error creating trip. Please try again.';
                showError(errorMsg);
                createTripBtn.disabled = false;
                createTripBtn.innerHTML = '<i class="fas fa-plus"></i> Create Trip';
            }
        }

        // Copy trip code
        function copyTripCode() {
            const tripCode = document.getElementById('tripCode').value;
            navigator.clipboard.writeText(tripCode);
            showNotification('‚úì Trip code copied!', 'success');
        }

        // Go to dashboard
        function goToDashboard() {
            window.location.href = '/Dashboard.html';
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                AuthService.logout();
            }
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Clear messages
        function clearMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            }[type];

            notification.className = `fixed top-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Map modal variables
        let mapInstance = null;
        let currentMapType = null;
        let selectedMapLat = null;
        let selectedMapLng = null;

        function openMapModal(type) {
            currentMapType = type;
            document.getElementById('mapModal').classList.remove('hidden');

            // Initialize map
            setTimeout(async () => {
                if (mapInstance) {
                    mapInstance.remove();
                }

                // Default to user's current location
                let initialLat = 30.836427;
                let initialLng = 76.960320;

                // Try to get current location first
                try {
                    const location = await LocationService.getCurrentLocation();
                    initialLat = location.latitude;
                    initialLng = location.longitude;
                } catch (e) {
                    // Use default
                }

                mapInstance = L.map('mapContainer').setView([initialLat, initialLng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(mapInstance);

                // Set marker on click
                mapInstance.on('click', function(e) {
                    selectedMapLat = e.latlng.lat;
                    selectedMapLng = e.latlng.lng;

                    // Remove old marker
                    document.querySelectorAll('.leaflet-marker-icon').forEach(marker => {
                        if (marker.parentElement.classList.contains('custom-marker')) {
                            marker.parentElement.remove();
                        }
                    });

                    // Add new marker
                    L.marker([selectedMapLat, selectedMapLng]).addTo(mapInstance);

                    // Show selected coordinates
                    document.getElementById('selectedCoords').textContent =
                        `${selectedMapLat.toFixed(6)}, ${selectedMapLng.toFixed(6)}`;
                });
            }, 100);
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.add('hidden');
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            selectedMapLat = null;
            selectedMapLng = null;
        }

        function confirmMapSelection() {
            if (selectedMapLat === null || selectedMapLng === null) {
                alert('Please select a location on the map');
                return;
            }

            if (currentMapType === 'pickup') {
                document.getElementById('pickupLat').value = selectedMapLat;
                document.getElementById('pickupLng').value = selectedMapLng;
                document.getElementById('pickupLocationName').value =
                    `üìç ${selectedMapLat.toFixed(6)}, ${selectedMapLng.toFixed(6)}`;
            } else if (currentMapType === 'dropoff') {
                document.getElementById('dropoffLat').value = selectedMapLat;
                document.getElementById('dropoffLng').value = selectedMapLng;
                document.getElementById('dropoffLocationName').value =
                    `üìç ${selectedMapLat.toFixed(6)}, ${selectedMapLng.toFixed(6)}`;
            }

            closeMapModal();
            showNotification('‚úì Location selected from map', 'success');
        }

        // Chat functionality variables
        let currentChatTripId = null;
        let currentChatRiderId = null;
        let currentChatRiderName = null;

        // Open chat modal with rider
        function openChat(riderId, riderName, tripId) {
            currentChatTripId = tripId;
            currentChatRiderId = riderId;
            currentChatRiderName = riderName;

            document.getElementById('chatRiderName').textContent = riderName;
            document.getElementById('chatTripId').textContent = tripId;
            document.getElementById('chatModal').classList.remove('hidden');
            document.getElementById('chatMessageInput').focus();

            // Load existing messages
            loadChatMessages();

            // Join trip room via socket to receive messages
            if (window.driverSocket) {
                window.driverSocket.emit('join-trip-room', { tripId: tripId });
                console.log('[DEBUG] Joined trip room:', tripId);
            }

            // Scroll to bottom
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.add('hidden');
            currentChatTripId = null;
            currentChatRiderId = null;
            currentChatRiderName = null;
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('chatMessageInput').value = '';
        }

        // Load messages from API
        async function loadChatMessages() {
            try {
                if (!currentChatTripId) return;

                const response = await MessageService.getMessages(currentChatTripId);
                if (response && response.messages) {
                    displayChatMessages(response.messages);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                showNotification('Failed to load messages', 'error');
            }
        }

        // Display messages in chat
        function displayChatMessages(messages) {
            const currentUserId = AuthService.getCurrentUser()?.id;
            const chatContainer = document.getElementById('chatMessages');

            if (messages.length === 0) {
                chatContainer.innerHTML = `
                    <div class="text-center text-gray-500 text-sm">
                        <i class="fas fa-comments text-4xl text-gray-300 mb-2"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            chatContainer.innerHTML = messages.map(msg => {
                const isOwn = msg.senderId._id === currentUserId;
                const alignClass = isOwn ? 'justify-end' : 'justify-start';
                const bgClass = isOwn ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-900';
                const senderName = `${msg.senderId.firstName} ${msg.senderId.lastName}`;

                return `
                    <div class="flex ${alignClass}">
                        <div class="max-w-xs">
                            ${!isOwn ? `<p class="text-xs font-semibold text-gray-600 mb-1">${senderName}</p>` : ''}
                            <div class="px-4 py-2 rounded-lg ${bgClass} break-words">
                                <p>${msg.messageText}</p>
                                <p class="text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'} mt-1">
                                    ${new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        async function sendChatMessage() {
            const messageText = document.getElementById('chatMessageInput').value.trim();

            if (!messageText) {
                showNotification('Please enter a message', 'error');
                return;
            }

            if (!currentChatTripId || !currentChatRiderId) {
                showNotification('Chat session not initialized', 'error');
                return;
            }

            try {
                const response = await MessageService.sendMessage(
                    currentChatTripId,
                    currentChatRiderId,
                    messageText
                );

                if (response && response.success) {
                    document.getElementById('chatMessageInput').value = '';
                    document.getElementById('chatMessageInput').focus();

                    // Reload messages to display the new one
                    await loadChatMessages();
                } else {
                    showNotification('Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Accept rider request
        async function acceptRiderRequest(riderId, riderName, tripId) {
            try {
                const response = await TripServiceAPI.respondToRider(tripId, riderId, 'accept');

                if (response && response.success) {
                    showNotification(`‚úì Accepted ${riderName}!`, 'success');

                    // Open chat with the rider
                    setTimeout(() => {
                        openChat(riderId, riderName, tripId);
                    }, 500);

                    // Reload active trip
                    setTimeout(() => {
                        loadActiveTrip();
                    }, 1000);
                } else {
                    showNotification('Failed to accept request', 'error');
                }
            } catch (error) {
                console.error('Error accepting request:', error);
                showNotification('Error accepting request', 'error');
            }
        }

        // Reject rider request
        async function rejectRiderRequest(riderId, riderName, tripId) {
            if (!confirm(`Reject ${riderName}'s request?`)) return;

            try {
                const response = await TripServiceAPI.respondToRider(tripId, riderId, 'reject');

                if (response && response.success) {
                    showNotification(`Rejected ${riderName}'s request`, 'success');

                    // Reload active trip
                    setTimeout(() => {
                        loadActiveTrip();
                    }, 500);
                } else {
                    showNotification('Failed to reject request', 'error');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                showNotification('Error rejecting request', 'error');
            }
        }
    </script>
</body>
</html>
